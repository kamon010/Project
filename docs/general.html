<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Classroom General</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@300..700&family=Inconsolata:wght@200..900&family=Jost:ital,wght@0,100..900;1,100..900&family=Signika:wght@300..700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Comfortaa", "Inconsolata", "Jost", "Signika", sans-serif;
        background-color: #2f2f2f;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        height: 100vh;
      }

      .topbar {
        background-color: #2e2e2e;
        padding: 10px 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        box-shadow: 0px 2px 4px rgba(177, 177, 177, 0.1);
        position: relative;
        z-index: 2;
      }

      .topbar .search-bar {
        flex-grow: 1;
        display: flex;
        justify-content: flex-start;
        position: relative;
        padding-left: 480px;
      }

      .topbar .search-bar input {
        width: 400px;
        padding: 5px 10px 5px 35px;
        border-radius: 20px;
        border: 1px solid #717171;
        background-color: #333;
        color: #979797;
        font-size: 16px;
        position: relative;
        z-index: 1;
      }

      .topbar .search-bar .fas {
        position: absolute;
        left: 490px;
        top: 50%;
        transform: translateY(-50%);
        color: #979797;
        z-index: 2;
      }

      .topbar .user-section {
        display: flex;
        align-items: center;
        position: relative;
      }

      #user-email {
        color: white;
        font-size: 16px;
        margin-right: 10px;
      }

      .user-icon {
        cursor: pointer;
        position: relative;
      }

      .user-icon i {
        font-size: 30px;
        color: white;
      }

      .dropdown-menu {
        display: none;
        position: absolute;
        right: 0;
        top: 50px;
        background-color: #fff;
        box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
        border-radius: 8px;
        overflow: hidden;
        z-index: 1000;
      }

      .dropdown-menu a {
        display: block;
        padding: 10px;
        color: #333;
        text-decoration: none;
        font-size: 14px;
      }

      .dropdown-menu a:hover {
        background-color: #f0f0f0;
      }

      .main-sidebar {
        width: 80px;
        background-color: #333;
        padding: 20px 0;
        box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        align-items: center;
        position: fixed;
        top: 60px;
        bottom: 0;
      }

      .main-sidebar a {
        display: flex;
        flex-direction: column;
        align-items: center;
        color: #ccc;
        padding: 15px 0;
        text-decoration: none;
        font-size: 12px;
      }

      .main-sidebar a i {
        font-size: 20px;
        margin-bottom: 5px;
      }

      .main-sidebar a:hover {
        background-color: #444;
        color: #fff;
        width: 100%;
        text-align: center;
      }

      .sidebar {
        width: 200px;
        background-color: #333;
        padding: 20px 0;
        box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        margin-left: 80px;
        position: fixed;
        top: 60px;
        bottom: 0;
      }

      .sidebar a {
        display: flex;
        align-items: center;
        color: #ccc;
        padding: 15px 20px;
        text-decoration: none;
        font-size: 16px;
      }

      .sidebar a i {
        margin-right: 10px;
      }

      .sidebar a:hover {
        background-color: #444;
        color: #fff;
      }

      .sidebar .main-channel {
        margin-top: 20px;
      }

      .sidebar .main-channel a {
        padding-left: 35px;
        font-size: 14px;
      }

      .course-name {
        display: flex;
        align-items: center;
        padding: 15px 20px;
        color: #fff;
        background-color: #444;
        margin-bottom: 10px;
      }

      .course-name i {
        margin-right: 10px;
      }

      #searchResults {
        background-color: rgb(86, 86, 86);
        color: black;
        position: absolute;
        z-index: 1000;
        width: 400px;
        border-radius: 5px;
        max-height: 400px;
        overflow-y: auto;
        box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
        top: 38px;
      }

      #searchResults .result-item {
        padding: 12px;
        cursor: pointer;
        border-bottom: 1px solid #a3a3a3;
        display: flex;
        align-items: center;
        font-size: 16px;
      }

      #searchResults .result-item:hover {
        background-color: #989898;
      }

      .search-info {
        display: flex;
        flex-direction: column;
      }

      .search-info span {
        font-size: 14px;
        color: #b2b2b2;
      }

      .search-info p {
        margin: 0;
        font-size: 16px;
        color: #b2b2b2;
      }

      .content {
        flex-grow: 1;
        background-color: #2c2c2c;
        display: flex;
        flex-direction: column;
        margin-left: 280px;
        padding-top: 60px;
      }

      .content-header {
        background-color: #202020;
        padding: 10px 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
        font-family: "Comfortaa", Arial, sans-serif;
      }

      .content-header h2 {
        margin: 0;
        font-size: 20px;
      }

      .content-header .header-options {
        display: flex;
        align-items: center;
      }

      .content-header .header-options a {
        margin-right: 15px;
        color: #ccc;
        text-decoration: none;
        font-size: 14px;
      }

      .content-header .header-options a:hover {
        color: #fff;
      }

      .content-body {
        padding: 20px;
        overflow-y: auto;
      }

      .post {
        background-color: #3b3b3b;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      }

      .post-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 10px;
        font-family: "Comfortaa", Arial, sans-serif;
      }

      .post-header h3 {
        margin: 0;
        font-size: 16px;
      }

      .post-header .post-date {
        font-size: 12px;
        color: #bbb;
      }

      .post-content {
        font-size: 14px;
        color: #ddd;
      }

      .reply-section {
        margin-top: 10px;
        border-top: 1px solid #444;
        padding-top: 10px;
      }

      .reply {
        background-color: #2c2c2c;
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 10px;
      }

      .reply p {
        margin: 0;
        font-size: 14px;
        color: #bbb;
      }

      .reply .reply-author {
        font-size: 12px;
        color: #888;
      }

      .start-post {
        margin-top: 20px;
        text-align: center;
      }

      .start-post button {
        background-color: #4caf50;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
      }

      .start-post button:hover {
        background-color: #45a049;
      }

      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
      }

      .modal-content {
        background-color: white;
        padding: 20px;
        border-radius: 10px;
        width: 400px;
        color: black;
      }

      .modal-content textarea {
        width: 100%;
        height: 100px;
        margin-bottom: 15px;
        padding: 10px;
        border-radius: 5px;
        border: 1px solid #ccc;
        font-size: 14px;
        resize: none;
      }

      .modal-content .attachments {
        display: flex;
        justify-content: space-between;
        margin-bottom: 15px;
      }

      .modal-content .attachments i {
        cursor: pointer;
        font-size: 20px;
        color: #333;
      }

      .modal-content .attachments i:hover {
        color: #555;
      }

      .modal-content button {
        background-color: #4caf50;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        float: right;
      }

      .modal-content button:hover {
        background-color: #45a049;
      }

      .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
      }

      .close:hover,
      .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
      }

      #fileContainer {
        padding: 10px;
        border: 1px dashed #ccc;
        border-radius: 10px;
        background-color: #f9f9f9;
        color: #333;
        margin-top: 10px;
        max-width: 300px;
        margin-left: auto;
        margin-right: auto;
        text-align: center;
        font-size: 14px;
        display: none; /* จะถูกแสดงก็ต่อเมื่อมีการแนบไฟล์ */
      }

      #fileContainer a {
        color: #4caf50;
        text-decoration: none;
        font-weight: bold;
      }

      #fileContainer a:hover {
        text-decoration: underline;
      }
    </style>
  </head>
  <body>
    <div class="topbar">
      <div class="search-bar">
        <i class="fas fa-search"></i>
        <input type="text" placeholder="ค้นหา (Cmd+E)" id="searchInput" />
        <div id="searchResults"></div>
      </div>
      <div class="user-section">
        <div id="user-email"></div>
        <div class="user-icon" id="userIcon">
          <i class="fas fa-user-circle"></i>
        </div>
        <div class="dropdown-menu" id="dropdownMenu">
          <a href="#">Profile</a>
          <a href="#">Log out</a>
        </div>
      </div>
    </div>

    <div class="main-sidebar">
      <div class="menu-items">
        <a href="#"
          ><i class="fa fa-chalkboard-teacher"></i><span>Classroom</span></a
        >
        <a href="#"><i class="fa fa-comments"></i><span>Chat</span></a>
        <a href="#"><i class="fa fa-bell"></i><span>Notifications</span></a>
        <a href="#"><i class="fa fa-tasks"></i><span>Assignment</span></a>
        <a href="#"><i class="fa fa-phone"></i><span>Call</span></a>
      </div>
    </div>

    <div class="sidebar">
      <div class="course-name" id="courseName">
        <i class="fas fa-users"></i>
      </div>
      <a href="#"><i class="fa fa-home"></i> Home page</a>
      <a href="#"><i class="fa fa-book"></i> งานที่สั่ง</a>
      <a href="#"><i class="fa fa-clipboard-list"></i>งานที่ส่ง</a>
      <a href="#"><i class="fa fa-tasks"></i>แจ้งเตือน</a>
      <a href="#"><i class="fa fa-retweet"></i> Reflect</a>
      <div class="main-channel">
        <a href="#"><i class="fa fa-home"></i> ทั่วไป</a>
      </div>
    </div>

    <div class="content">
      <div class="content-header">
        <h2>General</h2>
        <div class="header-options">
          <a href="#">Posts</a>
          <a href="#">Files</a>
        </div>
      </div>
      <div class="content-body">
        <div id="postContainer">
          <!-- Posts will be dynamically inserted here -->
        </div>
        <div class="start-post">
          <button onclick="openModal()">Start a post</button>
        </div>
      </div>
    </div>

    <!-- Modal for Creating Post -->
    <div id="postModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2>New Post</h2>
        <textarea id="postMessage" placeholder="Type a message"></textarea>

        <!-- แสดงตัวอย่างภาพ -->
        <div id="imageContainer"></div>

        <!-- แสดงชื่อไฟล์ -->
        <div id="fileContainer" style="margin-top: 10px"></div>

        <div class="attachments">
          <i class="fas fa-paperclip" onclick="attachFile()"></i>
          <i class="fas fa-link" onclick="attachLink()"></i>
          <i class="fas fa-image" onclick="attachImage()"></i>
        </div>
        <button onclick="submitPost()">Post</button>
      </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

    <script>
      // Firebase configuration
      var firebaseConfig = {
        apiKey: "AIzaSyC1qX4ttFX42SzVFbg6LqjNJv9rRSepYXw",
        authDomain: "project-63a86.firebaseapp.com",
        projectId: "team-1849c",
        storageBucket: "project-63a86.appspot.com",
        messagingSenderId: "448111875731",
        appId: "1:448111875731:web:6180e0c46cc10593051f66",
        measurementId: "G-SR4EFC2VFC",
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      var db = firebase.firestore();

      console.log("Firebase Loaded:", firebase.apps.length > 0); // ตรวจสอบการโหลด Firebase

      // Function to search email or username in both Teacher and Student collections
      document
        .getElementById("searchInput")
        .addEventListener("input", function (event) {
          var query = event.target.value.toLowerCase();
          var resultsContainer = document.getElementById("searchResults");

          if (query.length > 0) {
            resultsContainer.innerHTML = "";
            let allResults = new Set();

            // ค้นหาจากคอลเล็กชัน Student
            db.collection("Student")
              .orderBy("Username")
              .startAt(query)
              .endAt(query + "\uf8ff")
              .get()
              .then(function (querySnapshot) {
                querySnapshot.forEach(function (doc) {
                  var userData = doc.data();
                  allResults.add(
                    userData.Username + " (" + userData.Email + ")"
                  );
                });

                // ค้นหาอีเมล
                return db
                  .collection("Student")
                  .orderBy("Email")
                  .startAt(query)
                  .endAt(query + "\uf8ff")
                  .get();
              })
              .then(function (querySnapshot) {
                querySnapshot.forEach(function (doc) {
                  var userData = doc.data();
                  allResults.add(
                    userData.Username + " (" + userData.Email + ")"
                  );
                });

                // ค้นหาจากคอลเล็กชัน Teacher
                return db
                  .collection("Teacher")
                  .orderBy("Username")
                  .startAt(query)
                  .endAt(query + "\uf8ff")
                  .get();
              })
              .then(function (querySnapshot) {
                querySnapshot.forEach(function (doc) {
                  var userData = doc.data();
                  allResults.add(
                    userData.Username + " (" + userData.Email + ")"
                  );
                });

                // ค้นหาอีเมลจาก Teacher
                return db
                  .collection("Teacher")
                  .orderBy("Email")
                  .startAt(query)
                  .endAt(query + "\uf8ff")
                  .get();
              })
              .then(function (querySnapshot) {
                querySnapshot.forEach(function (doc) {
                  var userData = doc.data();
                  allResults.add(
                    userData.Username + " (" + userData.Email + ")"
                  );
                });

                // แสดงผลลัพธ์
                allResults.forEach(function (resultItem) {
                  var div = document.createElement("div");
                  div.className = "result-item";
                  div.textContent = resultItem;
                  resultsContainer.appendChild(div);
                });
              })
              .catch(function (error) {
                console.log("Error getting documents: ", error);
              });
          } else {
            resultsContainer.innerHTML = "";
          }
        });

      // ดึงพารามิเตอร์จาก URL และแสดงผล
      const urlParams = new URLSearchParams(window.location.search);
      const classroomName = urlParams.get("classroom");
      if (classroomName) {
        // กำหนดชื่อห้องเรียนที่ดึงจาก URL ไปยัง element ที่มี id="courseName"
        document.getElementById("courseName").innerHTML =
          '<i class="fas fa-users"></i> ' + classroomName;
      } else {
        // กรณีที่ไม่มีพารามิเตอร์ classroom ให้แสดงข้อความ "No classroom"
        document.getElementById("courseName").innerHTML =
          '<i class="fas fa-users"></i> No classroom';
      }
      const email = urlParams.get("email");

      console.log("Classroom:", classroomName); // ตรวจสอบค่าที่ดึงได้จาก URL
      console.log("Email:", email);

      async function fetchUserData(email) {
        let userRole = "";
        let username = "";

        if (email) {
          document.getElementById("user-email").textContent = email;

          // Check Teacher collection
          let querySnapshot = await db
            .collection("Teacher")
            .where("Email", "==", email)
            .get();
          if (!querySnapshot.empty) {
            const data = querySnapshot.docs[0].data();
            userRole = "Teacher";
            username = data.Username;
          } else {
            // Check Student collection
            querySnapshot = await db
              .collection("Student")
              .where("Email", "==", email)
              .get();
            if (!querySnapshot.empty) {
              const data = querySnapshot.docs[0].data();
              userRole = "Student";
              username = data.Username;
            }
          }

          // เก็บข้อมูล Username และ Role ใน window object เพื่อใช้งานต่อ
          window.userRole = userRole;
          window.username = username;
        }
      }

      // เรียกฟังก์ชันนี้เมื่อโหลดหน้าเสร็จ
      fetchUserData(email);

      // Function to fetch posts and display them based on type
      function fetchPosts() {
        const postContainer = document.getElementById("postContainer");
        postContainer.innerHTML = ""; // Clear previous posts

        db.collection("Post")
          .where("ClassroomName", "==", classroomName)
          .get()
          .then((querySnapshot) => {
            querySnapshot.forEach((doc) => {
              const data = doc.data();
              const postDiv = document.createElement("div");
              postDiv.classList.add("post");

              const postHeader = document.createElement("div");
              postHeader.classList.add("post-header");
              const postAuthor = document.createElement("h3");
              postAuthor.textContent = data.Username;
              const postDate = document.createElement("span");
              postDate.classList.add("post-date");
              postDate.textContent = new Date(
                data.Timestamp.toDate()
              ).toLocaleString();

              const postContent = document.createElement("div");
              postContent.classList.add("post-content");

              // ตรวจสอบประเภทของโพสต์
              if (data.PostType === "ข้อความ") {
                // โพสต์ข้อความ
                const postText = document.createElement("p");
                postText.textContent = data.Content;
                postContent.appendChild(postText);
              } else if (data.PostType === "รูปภาพ") {
                // โพสต์รูปภาพ
                const img = document.createElement("img");
                img.src = data.Content;
                img.style.maxWidth = "100%";
                img.style.borderRadius = "10px";
                postContent.appendChild(img);
              } else if (data.PostType === "ไฟล์") {
                // โพสต์ไฟล์
                const fileLink = document.createElement("a");
                fileLink.href = data.Content;
                fileLink.target = "_blank"; // เปิดในแท็บใหม่
                fileLink.textContent = "ดาวน์โหลดไฟล์ที่นี่";
                postContent.appendChild(fileLink);
              } else if (data.PostType === "ลิงก์") {
                // โพสต์ลิงก์
                const link = document.createElement("a");
                link.href = data.Content;
                link.target = "_blank"; // เปิดในแท็บใหม่
                link.textContent = data.Content;
                postContent.appendChild(link);
              }

              postHeader.appendChild(postAuthor);
              postHeader.appendChild(postDate);
              postDiv.appendChild(postHeader);
              postDiv.appendChild(postContent);

              postContainer.appendChild(postDiv);
            });
          })
          .catch((error) => {
            console.error("Error fetching posts: ", error);
          });
      }

      fetchPosts();

      // Function to submit a post
      function submitPost() {
        console.log("Submitting post..."); // ตรวจสอบว่าฟังก์ชันถูกเรียกใช้หรือไม่

        const message = document.getElementById("postMessage").value.trim();
        if (message === "") {
          alert("Message is required.");
          return;
        }
        console.log("Message:", message); // แสดงข้อความที่โพสต์

        const postType = determinePostType(message);
        const timestamp = firebase.firestore.FieldValue.serverTimestamp();
        const classroomName = urlParams.get("classroom");
        const email = urlParams.get("email");

        console.log("Classroom:", classroomName);
        console.log("Email:", email);

        if (!classroomName || !email) {
          alert("Classroom or Email is missing!");
          return;
        }

        // บันทึกข้อมูลโพสต์ลง Firestore
        db.collection("Post")
          .add({
            ClassroomName: classroomName, // ชื่อห้องเรียนที่ดึงจาก URL
            Username: window.username, // ชื่อผู้ใช้ที่ได้จาก fetchUserData
            Email: email, // อีเมลที่ดึงจาก URL
            PostType: postType,
            Content: message,
            Timestamp: timestamp,
          })
          .then(() => {
            alert("Post created successfully!");
            closeModal(); // ปิด modal เมื่อโพสต์สำเร็จ
          })
          .catch((error) => {
            console.error("Error creating post: ", error);
          });
      }

      // Function to determine post type
      function determinePostType(content) {
        // ตรวจสอบประเภทของโพส
        if (content.includes("http")) {
          return "ลิงก์";
        } else if (content.endsWith(".jpg") || content.endsWith(".png")) {
          return "รูปภาพ";
        } else {
          return "ข้อความ";
        }
      }

      // Function to open modal
      function openModal() {
        document.getElementById("postModal").style.display = "flex";
      }

      // Function to close modal
      function closeModal() {
        document.getElementById("postModal").style.display = "none";
      }

      // Function to attach and upload any file to Firebase Storage
      let attachedFileURL = "";
      let attachedFileType = "";

      // ฟังก์ชันสำหรับการแนบและอัปโหลดไฟล์ไปยัง Firebase Storage
      function attachFile() {
        const input = document.createElement("input");
        input.type = "file";
        input.accept = "*"; // รับไฟล์ทุกประเภท
        input.onchange = (e) => {
          const file = e.target.files[0]; // รับไฟล์ที่เลือกจากผู้ใช้
          if (file) {
            // สร้างตัวชี้อ้างอิงไปยัง Firebase Storage
            const storageRef = firebase.storage().ref("uploads/" + file.name);

            // อัปโหลดไฟล์ไปยัง Firebase Storage
            const uploadTask = storageRef.put(file);

            // ฟังก์ชันการติดตามสถานะการอัปโหลด
            uploadTask.on(
              "state_changed",
              (snapshot) => {
                // สามารถแสดงความคืบหน้าของการอัปโหลดได้ที่นี่
              },
              (error) => {
                console.error("เกิดข้อผิดพลาดในการอัปโหลดไฟล์: ", error);
              },
              () => {
                // เมื่ออัปโหลดเสร็จสมบูรณ์ ให้ดึง URL ของไฟล์
                uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                  console.log("ไฟล์สามารถเข้าถึงได้ที่", downloadURL);

                  // แสดงชื่อไฟล์และลิงก์ใน UI
                  const fileContainer =
                    document.getElementById("fileContainer");
                  fileContainer.innerHTML = `<a href="${downloadURL}" target="_blank">${file.name}</a>`;
                  fileContainer.style.display = "block"; // แสดงกล่อง fileContainer

                  // เก็บ URL ของไฟล์และประเภทของไฟล์ไว้ใช้งานภายหลัง
                  attachedFileURL = downloadURL;
                  attachedFileType = "ไฟล์";
                });
              }
            );
          }
        };
        input.click();
      }

      // Function to attach and upload image to Firebase Storage
      function attachImage() {
        const input = document.createElement("input");
        input.type = "file";
        input.accept = "image/*"; // รับเฉพาะไฟล์รูปภาพ
        input.onchange = (e) => {
          const file = e.target.files[0]; // รับไฟล์ที่ผู้ใช้อัปโหลด
          if (file) {
            const reader = new FileReader(); // ใช้ FileReader เพื่อแสดงตัวอย่างรูปภาพก่อนที่จะอัพโหลด

            reader.onload = function (event) {
              // แสดงตัวอย่างภาพใน UI ก่อนอัปโหลด
              const img = document.createElement("img");
              img.src = event.target.result; // ดึงภาพจาก FileReader
              img.style.maxWidth = "100%";
              img.style.borderRadius = "10px";

              const imageContainer = document.getElementById("imageContainer");
              imageContainer.innerHTML = ""; // ล้างภาพก่อนหน้า
              imageContainer.appendChild(img); // แสดงภาพที่อัปโหลด
            };

            reader.readAsDataURL(file); // อ่านไฟล์รูปภาพจากคอมพิวเตอร์ผู้ใช้

            // สร้าง reference สำหรับเก็บไฟล์ใน Firebase Storage
            const storageRef = firebase.storage().ref("images/" + file.name);

            // อัปโหลดไฟล์ไปยัง Firebase Storage
            const uploadTask = storageRef.put(file);

            // ติดตามสถานะการอัปโหลด
            uploadTask.on(
              "state_changed",
              (snapshot) => {
                const progress =
                  (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                console.log("Upload is " + progress + "% done");
              },
              (error) => {
                console.error("Error during upload: ", error);
              },
              () => {
                uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                  console.log("File available at", downloadURL);

                  // เก็บ URL ของรูปภาพเพื่อใช้ในภายหลัง
                  attachedFileURL = downloadURL;
                  attachedFileType = "รูปภาพ";
                });
              }
            );
          }
        };
        input.click();
      }

      // Function to submit a post

      // Function to submit a post
      async function submitPost() {
        console.log("Submitting post...");

        const message = document.getElementById("postMessage").value.trim();
        if (message === "" && attachedFileURL === "") {
          alert("Message or attachment is required.");
          return;
        }

        const timestamp = firebase.firestore.FieldValue.serverTimestamp();
        const classroomName = urlParams.get("classroom");
        const email = urlParams.get("email");

        if (!classroomName || !email) {
          alert("Classroom or Email is missing!");
          return;
        }

        // ตรวจสอบว่ามีการอัพโหลดรูปภาพเสร็จแล้วหรือไม่
        if (attachedFileType === "รูปภาพ" && attachedFileURL === "") {
          alert("Please wait for the image to upload.");
          return;
        }

        // บันทึกข้อมูลโพสต์ลง Firestore
        try {
          await db.collection("Post").add({
            ClassroomName: classroomName,
            Username: window.username,
            Email: email,
            PostType: attachedFileType ? attachedFileType : "ข้อความ",
            Content: attachedFileURL ? attachedFileURL : message, // ตรวจสอบว่ามี URL หรือไม่
            Message: message,
            Timestamp: timestamp,
          });

          alert("Post created successfully!");
          closeModal(); // ปิด modal เมื่อโพสต์สำเร็จ
          attachedFileURL = ""; // เคลียร์ค่าหลังจากโพสต์
          attachedFileType = ""; // เคลียร์ค่าหลังจากโพสต์
          document.getElementById("postMessage").value = ""; // ลบข้อความที่พิมพ์
          document.getElementById("imageContainer").innerHTML = ""; // ลบตัวอย่างรูปภาพ
        } catch (error) {
          console.error("Error creating post: ", error);
        }
      }
    </script>
  </body>
</html>
